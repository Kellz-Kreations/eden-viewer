<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eden Viewer Setup</title>
  <style>
    /* Windows 11 / Fluent 2 Design System */
    :root {
      --font-family: "Segoe UI Variable", "Segoe UI", system-ui, -apple-system, sans-serif;
      --bg-solid: #f3f3f3;
      --bg-card: #ffffff;
      --bg-subtle: #f9f9f9;
      --bg-control: #ffffff;
      --text-primary: #1a1a1a;
      --text-secondary: #616161;
      --text-tertiary: #8a8a8a;
      --stroke: #e0e0e0;
      --stroke-control: #d1d1d1;
      --accent: #0067c0;
      --accent-hover: #005a9e;
      --accent-text: #ffffff;
      --success: #0f7b0f;
      --success-bg: #dff6dd;
      --warning: #9d5d00;
      --warning-bg: #fff4ce;
      --error: #c42b1c;
      --error-bg: #fde7e9;
      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --shadow-card: 0 2px 4px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.06);
      --shadow-elevated: 0 8px 16px rgba(0,0,0,0.08), 0 2px 4px rgba(0,0,0,0.06);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg-solid: #202020;
        --bg-card: #2d2d2d;
        --bg-subtle: #252525;
        --bg-control: #3d3d3d;
        --text-primary: #ffffff;
        --text-secondary: #c5c5c5;
        --text-tertiary: #9a9a9a;
        --stroke: #3d3d3d;
        --stroke-control: #4d4d4d;
        --accent: #60cdff;
        --accent-hover: #4cc2ff;
        --accent-text: #000000;
        --success: #6ccb5f;
        --success-bg: rgba(108,203,95,0.15);
        --warning: #fce100;
        --warning-bg: rgba(252,225,0,0.15);
        --error: #ff99a4;
        --error-bg: rgba(255,153,164,0.15);
        --shadow-card: 0 2px 4px rgba(0,0,0,0.2);
        --shadow-elevated: 0 8px 16px rgba(0,0,0,0.3);
      }
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: var(--font-family);
      font-size: 14px;
      line-height: 1.5;
      color: var(--text-primary);
      background: var(--bg-solid);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 48px 24px;
      -webkit-font-smoothing: antialiased;
    }

    .setup-container {
      width: 100%;
      max-width: 580px;
    }

    /* Header / Branding */
    .setup-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .setup-header h1 {
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 8px;
      letter-spacing: -0.5px;
    }

    .setup-header p {
      color: var(--text-secondary);
      font-size: 14px;
    }

    /* Progress Stepper */
    .stepper {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 32px;
    }

    .stepper-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--stroke);
      transition: all 200ms ease;
    }

    .stepper-dot.active {
      background: var(--accent);
      box-shadow: 0 0 0 4px rgba(0,103,192,0.2);
    }

    .stepper-dot.complete {
      background: var(--success);
    }

    .stepper-line {
      width: 32px;
      height: 2px;
      background: var(--stroke);
      transition: background 200ms ease;
    }

    .stepper-line.complete {
      background: var(--success);
    }

    /* Card */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-card);
      padding: 32px;
    }

    /* Steps */
    .step { display: none; }
    .step.active { display: block; }

    .step-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .step-description {
      color: var(--text-secondary);
      margin-bottom: 24px;
    }

    /* Form Controls */
    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 6px;
    }

    .form-group .optional {
      font-weight: 400;
      color: var(--text-tertiary);
    }

    .form-group input,
    .form-group select {
      width: 100%;
      height: 36px;
      padding: 0 12px;
      font-family: inherit;
      font-size: 14px;
      color: var(--text-primary);
      background: var(--bg-control);
      border: 1px solid var(--stroke-control);
      border-radius: var(--radius-sm);
      transition: border-color 150ms ease, box-shadow 150ms ease;
    }

    .form-group input:hover,
    .form-group select:hover {
      border-color: var(--text-tertiary);
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent);
    }

    .form-group .hint {
      font-size: 12px;
      color: var(--text-tertiary);
      margin-top: 4px;
    }

    .form-group .hint a {
      color: var(--accent);
      text-decoration: none;
    }

    .form-group .hint a:hover {
      text-decoration: underline;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    /* Checkbox List */
    .checkbox-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 24px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--bg-subtle);
      border: 1px solid var(--stroke);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 150ms ease;
    }

    .checkbox-item:hover {
      background: var(--bg-control);
      border-color: var(--stroke-control);
    }

    .checkbox-item input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: var(--accent);
      cursor: pointer;
    }

    .checkbox-item .label-text {
      flex: 1;
    }

    .checkbox-item .label-text strong {
      display: block;
      font-weight: 600;
    }

    .checkbox-item .label-text span {
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      height: 36px;
      padding: 0 20px;
      font-family: inherit;
      font-size: 14px;
      font-weight: 500;
      border-radius: var(--radius-sm);
      border: none;
      cursor: pointer;
      transition: all 150ms ease;
    }

    .btn-primary {
      background: var(--accent);
      color: var(--accent-text);
    }

    .btn-primary:hover {
      background: var(--accent-hover);
    }

    .btn-secondary {
      background: var(--bg-control);
      color: var(--text-primary);
      border: 1px solid var(--stroke-control);
    }

    .btn-secondary:hover {
      background: var(--bg-subtle);
    }

    .btn-group {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      margin-top: 32px;
    }

    /* Status Boxes */
    .status-box {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 16px;
      border-radius: var(--radius-md);
      margin-bottom: 16px;
    }

    .status-box.info {
      background: var(--bg-subtle);
      border: 1px solid var(--stroke);
    }

    .status-box.success {
      background: var(--success-bg);
      border: 1px solid var(--success);
      color: var(--success);
    }

    .status-box.warning {
      background: var(--warning-bg);
      border: 1px solid var(--warning);
      color: var(--warning);
    }

    .status-box.error {
      background: var(--error-bg);
      border: 1px solid var(--error);
      color: var(--error);
    }

    .status-box .status-icon {
      font-size: 20px;
      flex-shrink: 0;
    }

    .status-box .status-content h4 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .status-box .status-content p {
      font-size: 13px;
      opacity: 0.9;
    }

    /* Success State */
    .success-state {
      text-align: center;
      padding: 24px 0;
    }

    .success-state .check-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 20px;
      background: var(--success-bg);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--success);
      font-size: 32px;
    }

    .success-state h2 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .success-state p {
      color: var(--text-secondary);
    }

    /* Action Card */
    .action-card {
      background: var(--bg-subtle);
      border: 1px solid var(--stroke);
      border-radius: var(--radius-md);
      padding: 20px;
      margin: 24px 0;
      text-align: center;
    }

    .action-card h3 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .action-card p {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    /* Links Footer */
    .links-footer {
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid var(--stroke);
      text-align: center;
      font-size: 13px;
      color: var(--text-tertiary);
    }

    .links-footer a {
      color: var(--accent);
      text-decoration: none;
    }

    .links-footer a:hover {
      text-decoration: underline;
    }

    /* Claim Instructions */
    .claim-card {
      background: var(--bg-subtle);
      border: 1px solid var(--stroke);
      border-radius: var(--radius-md);
      padding: 16px;
      margin: 12px 0;
    }

    .claim-card h5 {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .claim-card ol {
      margin: 0;
      padding-left: 20px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .claim-card ol li {
      margin-bottom: 4px;
    }

    .claim-card code {
      font-family: "Cascadia Code", "Consolas", monospace;
      font-size: 12px;
      background: var(--bg-control);
      padding: 2px 6px;
      border-radius: 4px;
    }

    @media (max-width: 480px) {
      body { padding: 24px 16px; }
      .card { padding: 24px 20px; }
      .form-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="setup-container">
    <div class="setup-header">
      <h1>Eden Viewer</h1>
      <p>Media Stack Setup</p>
    </div>

    <div class="stepper" id="progress"></div>

    <div class="card">
      <!-- Step 1: Welcome -->
      <div class="step active" data-step="1">
        <h2 class="step-title">Welcome</h2>
        <p class="step-description">Let's set up your media server. This wizard will configure Plex, Sonarr, and Radarr for your environment.</p>
        
        <div class="status-box info">
          <div class="status-icon">üí°</div>
          <div class="status-content">
            <h4>Supported Platforms</h4>
            <p>Synology DS923+, Azure Container Apps, or any Docker host.</p>
          </div>
        </div>

        <div class="btn-group">
          <span></span>
          <button class="btn btn-primary" onclick="nextStep()">Get Started</button>
        </div>
      </div>

      <!-- Step 2: Storage Paths -->
      <div class="step" data-step="2">
        <h2 class="step-title">Storage Paths</h2>
        <p class="step-description">Configure where your media and application data will be stored.</p>

        <div class="form-group">
          <label>Media Data Path</label>
          <input type="text" id="dataPath" value="/volume1/data" placeholder="/volume1/data">
          <p class="hint">Root folder for movies and TV shows</p>
        </div>

        <div class="form-group">
          <label>Application Data Path</label>
          <input type="text" id="appdataPath" value="/volume1/docker/appdata" placeholder="/volume1/docker/appdata">
          <p class="hint">Configuration and database storage</p>
        </div>

        <div class="form-group">
          <label>Plex Claim Token <span class="optional">(optional)</span></label>
          <input type="text" id="plexClaim" placeholder="claim-xxxxxxxxxxxx">
          <p class="hint">Get your token from <a href="https://www.plex.tv/claim/" target="_blank">plex.tv/claim</a> ‚Äî valid for 4 minutes</p>
        </div>

        <div class="btn-group">
          <button class="btn btn-secondary" onclick="prevStep()">Back</button>
          <button class="btn btn-primary" onclick="nextStep()">Next</button>
        </div>
      </div>

      <!-- Step 3: Environment -->
      <div class="step" data-step="3">
        <h2 class="step-title">Environment</h2>
        <p class="step-description">Set container permissions and timezone.</p>

        <div class="form-row">
          <div class="form-group">
            <label>PUID (User ID)</label>
            <input type="text" id="puid" value="1000">
            <p class="hint">Run <code>id -u</code> to find yours</p>
          </div>
          <div class="form-group">
            <label>PGID (Group ID)</label>
            <input type="text" id="pgid" value="1000">
            <p class="hint">Run <code>id -g</code> to find yours</p>
          </div>
        </div>

        <div class="form-group">
          <label>Timezone</label>
          <select id="tz">
            <option value="America/Los_Angeles">America/Los_Angeles (Pacific)</option>
            <option value="America/Denver">America/Denver (Mountain)</option>
            <option value="America/Chicago">America/Chicago (Central)</option>
            <option value="America/New_York">America/New_York (Eastern)</option>
            <option value="Europe/London">Europe/London</option>
            <option value="Europe/Paris">Europe/Paris</option>
            <option value="Asia/Tokyo">Asia/Tokyo</option>
            <option value="UTC">UTC</option>
          </select>
        </div>

        <div class="btn-group">
          <button class="btn btn-secondary" onclick="prevStep()">Back</button>
          <button class="btn btn-primary" onclick="nextStep()">Next</button>
        </div>
      </div>

      <!-- Step 4: Services -->
      <div class="step" data-step="4">
        <h2 class="step-title">Services</h2>
        <p class="step-description">Select which services to include in your stack.</p>

        <div class="checkbox-list">
          <label class="checkbox-item">
            <input type="checkbox" id="svc-plex" checked>
            <div class="label-text">
              <strong>Plex Media Server</strong>
              <span>Stream your media anywhere</span>
            </div>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" id="svc-sonarr" checked>
            <div class="label-text">
              <strong>Sonarr</strong>
              <span>TV show management & automation</span>
            </div>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" id="svc-radarr" checked>
            <div class="label-text">
              <strong>Radarr</strong>
              <span>Movie management & automation</span>
            </div>
          </label>
        </div>

        <div id="plexStatusSection" class="status-box info">
          <div class="status-icon">üîç</div>
          <div class="status-content">
            <p id="plexStatusText">Checking Plex status...</p>
          </div>
        </div>

        <div id="claimSection" style="display: none;">
          <div class="status-box warning">
            <div class="status-icon">‚ö†Ô∏è</div>
            <div class="status-content">
              <h4>Server Not Claimed</h4>
              <p>Your Plex server needs to be linked to your account.</p>
            </div>
          </div>
          <div class="form-group">
            <input type="text" id="newClaimCode" placeholder="claim-xxxxxxxxxxxx">
          </div>
          <div style="display: flex; gap: 8px;">
            <a href="https://www.plex.tv/claim/" target="_blank" class="btn btn-secondary">Get Token</a>
            <button class="btn btn-secondary" onclick="recheckPlex()">Check Again</button>
          </div>
        </div>

        <div class="btn-group">
          <button class="btn btn-secondary" onclick="prevStep()">Back</button>
          <button class="btn btn-primary" onclick="saveConfig()">Complete Setup</button>
        </div>
      </div>

      <!-- Step 5: Complete -->
      <div class="step" data-step="5">
        <div class="success-state">
          <div class="check-icon">‚úì</div>
          <h2>Setup Complete</h2>
          <p>Your Eden Viewer media stack is configured and ready.</p>
        </div>

        <div id="plexClaimStatus" class="status-box info">
          <div class="status-icon">üîç</div>
          <div class="status-content">
            <p>Checking Plex server status...</p>
          </div>
        </div>

        <div class="action-card" id="cloudAccessSection">
          <h3>Access Your Plex Server</h3>
          <p>For cloud deployments, access Plex through the official app. This bypasses the local network requirement.</p>
          <a href="https://app.plex.tv" target="_blank" class="btn btn-primary">Open app.plex.tv</a>
        </div>

        <div id="plexClaimed" class="status-box success" style="display: none;">
          <div class="status-icon">‚úì</div>
          <div class="status-content">
            <h4>Server Claimed</h4>
            <p>Your Plex server is linked to your account and ready to use.</p>
          </div>
        </div>

        <div id="plexNotClaimed" style="display: none;">
          <div class="status-box warning">
            <div class="status-icon">‚ö†Ô∏è</div>
            <div class="status-content">
              <h4>Server Not Yet Claimed</h4>
              <p>Your Plex server is running but needs to be linked to your account.</p>
            </div>
          </div>

          <div class="claim-card">
            <h5>Option 1: Environment Variable</h5>
            <ol>
              <li>Go to <a href="https://www.plex.tv/claim/" target="_blank">plex.tv/claim</a></li>
              <li>Copy the token (expires in 4 min)</li>
              <li>Set <code>PLEX_CLAIM=claim-xxx</code></li>
              <li>Restart the Plex container</li>
            </ol>
          </div>

          <div class="claim-card">
            <h5>Option 2: SSH Tunnel</h5>
            <ol>
              <li>Run: <code>ssh -L 32400:localhost:32400 user@server</code></li>
              <li>Open <a href="http://localhost:32400/web" target="_blank">localhost:32400/web</a></li>
              <li>Sign in with your Plex account</li>
            </ol>
          </div>

          <button class="btn btn-secondary" onclick="checkPlexStatus()" style="margin-top: 12px;">Refresh Status</button>
        </div>

        <div id="plexOfflineMsg" class="status-box error" style="display: none;">
          <div class="status-icon">‚úï</div>
          <div class="status-content">
            <p>Plex is not running. Start the Docker stack first.</p>
          </div>
        </div>

        <div class="links-footer">
          <strong>Direct Links</strong> (local only)<br>
          <a href="http://localhost:32400/web" target="_blank">Plex :32400</a> ¬∑ 
          <a href="http://localhost:8989" target="_blank">Sonarr :8989</a> ¬∑ 
          <a href="http://localhost:7878" target="_blank">Radarr :7878</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentStep = 1;
    const totalSteps = 5;

    function updateProgress() {
      const p = document.getElementById('progress');
      let html = '';
      for (let i = 1; i <= totalSteps; i++) {
        const cls = i < currentStep ? 'complete' : (i === currentStep ? 'active' : '');
        html += `<div class="stepper-dot ${cls}"></div>`;
        if (i < totalSteps) {
          html += `<div class="stepper-line ${i < currentStep ? 'complete' : ''}"></div>`;
        }
      }
      p.innerHTML = html;
      
      document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
      const activeStep = document.querySelector(`[data-step="${currentStep}"]`);
      if (activeStep) activeStep.classList.add('active');
    }

    function nextStep() {
      if (currentStep < totalSteps) {
        currentStep++;
        updateProgress();
        if (currentStep === 4 || currentStep === 5) checkPlexOnLoad();
      }
    }

    function prevStep() {
      if (currentStep > 1) {
        currentStep--;
        updateProgress();
      }
    }

    function collectConfig() {
      return {
        dataPath: document.getElementById('dataPath')?.value,
        appdataPath: document.getElementById('appdataPath')?.value,
        plexClaim: document.getElementById('plexClaim')?.value,
        puid: document.getElementById('puid')?.value,
        pgid: document.getElementById('pgid')?.value,
        tz: document.getElementById('tz')?.value,
        services: {
          plex: document.getElementById('svc-plex')?.checked,
          sonarr: document.getElementById('svc-sonarr')?.checked,
          radarr: document.getElementById('svc-radarr')?.checked
        }
      };
    }

    async function saveConfig() {
      try {
        await fetch('/api/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(collectConfig())
        });
        nextStep();
      } catch (e) {
        alert('Error saving config: ' + e.message);
      }
    }

    async function checkPlexOnLoad() {
      const statusText = document.getElementById('plexStatusText');
      const claimSection = document.getElementById('claimSection');
      const claimStatus = document.getElementById('plexClaimStatus');
      const notClaimedBox = document.getElementById('plexNotClaimed');
      const claimedBox = document.getElementById('plexClaimed');
      const offlineMsg = document.getElementById('plexOfflineMsg');
      const statusSection = document.getElementById('plexStatusSection');

      try {
        const res = await fetch('/api/plex-status');
        const data = await res.json();

        if (data.online && data.claimed) {
          if (statusText) statusText.textContent = 'Plex is online and claimed';
          if (statusSection) statusSection.className = 'status-box success';
          if (statusSection) statusSection.querySelector('.status-icon').textContent = '‚úì';
          if (claimSection) claimSection.style.display = 'none';
        } else if (data.online && !data.claimed) {
          if (statusText) statusText.textContent = 'Plex is online but not claimed';
          if (statusSection) statusSection.className = 'status-box warning';
          if (statusSection) statusSection.querySelector('.status-icon').textContent = '‚ö†Ô∏è';
          if (claimSection) claimSection.style.display = 'block';
        } else {
          if (statusText) statusText.textContent = 'Plex is offline';
          if (statusSection) statusSection.className = 'status-box error';
          if (statusSection) statusSection.querySelector('.status-icon').textContent = '‚úï';
          if (claimSection) claimSection.style.display = 'none';
        }

        if (claimStatus) {
          const icon = claimStatus.querySelector('.status-icon');
          const content = claimStatus.querySelector('.status-content p');
          if (data.online && data.claimed) {
            claimStatus.className = 'status-box success';
            icon.textContent = '‚úì';
            content.textContent = 'Plex is online and claimed.';
          } else if (data.online) {
            claimStatus.className = 'status-box warning';
            icon.textContent = '‚ö†Ô∏è';
            content.textContent = 'Plex is online but not claimed.';
          } else {
            claimStatus.className = 'status-box error';
            icon.textContent = '‚úï';
            content.textContent = 'Plex is offline.';
          }
        }
        
        if (offlineMsg) offlineMsg.style.display = data.online ? 'none' : 'block';
        if (notClaimedBox) notClaimedBox.style.display = (data.online && !data.claimed) ? 'block' : 'none';
        if (claimedBox) claimedBox.style.display = (data.online && data.claimed) ? 'block' : 'none';

        return data;
      } catch (err) {
        if (statusText) statusText.textContent = 'Could not connect to Plex';
        if (statusSection) statusSection.className = 'status-box error';
        if (claimStatus) {
          claimStatus.className = 'status-box error';
          claimStatus.querySelector('.status-content p').textContent = 'Could not connect to Plex.';
        }
        if (offlineMsg) offlineMsg.style.display = 'block';
        if (notClaimedBox) notClaimedBox.style.display = 'none';
        return null;
      }
    }

    function recheckPlex() {
      document.getElementById('plexStatusText').textContent = 'Checking...';
      checkPlexOnLoad();
    }

    function checkPlexStatus() {
      return checkPlexOnLoad();
    }

    updateProgress();
    fetch('/api/status')
      .then(r => r.json())
      .then(d => { if (!d.firstRun) { currentStep = 5; updateProgress(); } })
      .catch(() => {});
    checkPlexStatus();
  </script>
</body>
</html>