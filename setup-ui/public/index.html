<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eden Viewer Setup</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); min-height: 100vh; color: #fff; }
    .container { max-width: 600px; margin: 0 auto; padding: 40px 20px; }
    .logo { text-align: center; margin-bottom: 40px; }
    .logo h1 { font-size: 2.5rem; background: linear-gradient(90deg, #e94560, #0f3460); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .card { background: rgba(255,255,255,0.1); border-radius: 16px; padding: 30px; margin-bottom: 20px; backdrop-filter: blur(10px); }
    .step { display: none; } .step.active { display: block; }
    h2 { margin-bottom: 20px; color: #e94560; }
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; font-weight: 500; }
    input, select { width: 100%; padding: 12px; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.1); color: #fff; font-size: 1rem; }
    input:focus, select:focus { outline: none; border-color: #e94560; }
    .checkbox-group { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .checkbox-group input { width: auto; }
    .btn { padding: 14px 28px; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; transition: all 0.3s; }
    .btn-primary { background: #e94560; color: #fff; } .btn-primary:hover { background: #d63850; }
    .btn-secondary { background: rgba(255,255,255,0.2); color: #fff; } .btn-secondary:hover { background: rgba(255,255,255,0.3); }
    .btn-group { display: flex; gap: 10px; justify-content: space-between; margin-top: 30px; }
    .progress { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; }
    .progress-dot { width: 12px; height: 12px; border-radius: 50%; background: rgba(255,255,255,0.3); }
    .progress-dot.active { background: #e94560; }
    .success { text-align: center; } .success svg { width: 80px; height: 80px; color: #4ade80; margin-bottom: 20px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo"><h1>üé¨ Eden Viewer</h1><p>Media Stack Setup</p></div>
    <div class="progress" id="progress"></div>
    <div class="card">
      <!-- Step 1: Welcome -->
      <div class="step active" data-step="1">
        <h2>Welcome!</h2>
        <p>Let's configure your Eden Viewer media stack. This wizard will guide you through setting up Plex, Sonarr, and Radarr.</p>
        <p style="margin-top:15px;opacity:0.8">Works with Synology DS923+ and Azure deployments.</p>
        <div class="btn-group"><div></div><button class="btn btn-primary" onclick="nextStep()">Get Started ‚Üí</button></div>
      </div>
      <!-- Step 2: Paths -->
      <div class="step" data-step="2">
        <h2>Storage Paths</h2>
        <div class="form-group"><label>Media Data Path</label><input type="text" id="dataPath" value="/volume1/data" placeholder="/volume1/data"></div>
        <div class="form-group"><label>App Data Path</label><input type="text" id="appdataPath" value="/volume1/docker/appdata" placeholder="/volume1/docker/appdata"></div>
        <div class="form-group">
          <label>Plex Claim Token (Optional)</label>
          <input type="text" id="plexClaim" placeholder="claim-xxxxxxxxxxxx">
          <p style="margin-top:8px;font-size:0.9rem;opacity:0.8">
            Get your claim token from <a href="https://www.plex.tv/claim/" target="_blank" rel="noopener" style="color:#e94560">plex.tv/claim</a> (valid for 4 minutes)
          </p>
        </div>
        <div class="btn-group"><button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button><button class="btn btn-primary" onclick="nextStep()">Next ‚Üí</button></div>
      </div>
      <!-- Step 3: Environment -->
      <div class="step" data-step="3">
        <h2>Environment Settings</h2>
        <div class="form-group"><label>PUID (User ID)</label><input type="text" id="puid" value="1000"></div>
        <div class="form-group"><label>PGID (Group ID)</label><input type="text" id="pgid" value="1000"></div>
        <div class="form-group"><label>Timezone</label><select id="tz"><option value="America/Los_Angeles">America/Los_Angeles</option><option value="America/New_York">America/New_York</option><option value="Europe/London">Europe/London</option><option value="UTC">UTC</option></select></div>
        <div class="btn-group"><button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button><button class="btn btn-primary" onclick="nextStep()">Next ‚Üí</button></div>
      </div>
      <!-- Step 4: Services -->
      <div class="step" data-step="4">
        <h2>Select Services</h2>
        <div class="checkbox-group"><input type="checkbox" id="svc-plex" checked><label for="svc-plex">Plex Media Server</label></div>
        <div class="checkbox-group"><input type="checkbox" id="svc-sonarr" checked><label for="svc-sonarr">Sonarr (TV Shows)</label></div>
        <div class="checkbox-group"><input type="checkbox" id="svc-radarr" checked><label for="svc-radarr">Radarr (Movies)</label></div>
        
        <div id="plexStatusSection" style="margin: 20px 0;">
          <p id="plexStatusText">üîç Checking Plex status...</p>
        </div>
        
        <button id="launchPlexBtnStep4" class="btn btn-primary btn-launch-plex" onclick="launchPlex(event)">
          üé¨ Launch Plex
        </button>
        
        <div id="claimSection" style="display: none; margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px;">
          <h4>‚ö†Ô∏è Server Not Claimed</h4>
          <p>Get a claim code from <a href="https://www.plex.tv/claim/" target="_blank">plex.tv/claim</a> (expires in 4 min)</p>
          <input type="text" id="newClaimCode" placeholder="claim-xxxxxxxxxxxx" style="width: 100%; padding: 8px; margin: 10px 0;">
          <button class="btn btn-secondary" onclick="recheckPlex()">üîÑ Check Again</button>
        </div>
        
        <div class="btn-group"><button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button><button class="btn btn-primary" onclick="saveConfig()">Complete Setup ‚Üí</button></div>
      </div>
      <!-- Step 5: Complete -->
      <div class="step" data-step="5">
        <div class="success">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
          <h2>Setup Complete!</h2>
          <p>Your Eden Viewer stack is configured and ready to go.</p>
          
          <div id="plexLaunchSection">
            <div id="plexClaimStatus" style="margin-bottom: 15px;">
              <p>üîç Checking Plex server status...</p>
            </div>
            
            <!-- Cloud/Remote deployment: Use app.plex.tv -->
            <div id="cloudAccessSection" style="margin: 20px 0; padding: 20px; background: rgba(233,69,96,0.1); border-radius: 12px; border: 1px solid #e94560;">
              <h3 style="margin-bottom: 15px;">üåê Access Your Plex Server</h3>
              <p style="margin-bottom: 15px;">For cloud deployments (Azure, remote servers), access Plex through the official Plex app:</p>
              
              <a href="https://app.plex.tv" target="_blank" class="btn btn-primary" style="display: inline-block; text-decoration: none; margin-bottom: 15px;">
                üé¨ Open app.plex.tv
              </a>
              
              <p style="font-size: 0.9rem; opacity: 0.9;">
                Sign in with your Plex account. Your server will appear in the sidebar once claimed.<br>
                This bypasses the "local network" requirement that blocks direct access.
              </p>
            </div>
            
            <div id="plexNotClaimed" style="display: none; margin-top: 15px; padding: 15px; background: #fff3cd; border-radius: 8px; color: #333;">
              <h4>‚ö†Ô∏è Server Not Yet Claimed</h4>
              <p style="margin: 10px 0;">Your Plex server is running but needs to be linked to your Plex account.</p>
              
              <div style="background: #fff; padding: 15px; border-radius: 8px; margin: 15px 0;">
                <strong>Option 1: Claim via Environment Variable</strong>
                <ol style="margin: 10px 0 0 20px; text-align: left;">
                  <li>Go to <a href="https://www.plex.tv/claim/" target="_blank" style="color:#e94560">plex.tv/claim</a></li>
                  <li>Copy the token (expires in 4 minutes)</li>
                  <li>Set <code>PLEX_CLAIM=claim-xxx</code> in your environment</li>
                  <li>Restart the Plex container</li>
                </ol>
              </div>
              
              <div style="background: #fff; padding: 15px; border-radius: 8px;">
                <strong>Option 2: Claim via SSH Tunnel (Advanced)</strong>
                <ol style="margin: 10px 0 0 20px; text-align: left;">
                  <li>SSH tunnel: <code>ssh -L 32400:localhost:32400 user@server</code></li>
                  <li>Open <a href="http://localhost:32400/web" target="_blank" style="color:#e94560">localhost:32400/web</a></li>
                  <li>Sign in with your Plex account</li>
                </ol>
              </div>
              
              <button class="btn btn-secondary" onclick="checkPlexStatus()" style="margin-top: 15px;">üîÑ Refresh Status</button>
            </div>
            
            <div id="plexClaimed" style="display: none; margin-top: 15px; padding: 15px; background: #d4edda; border-radius: 8px; color: #333;">
              <h4>‚úÖ Server Claimed!</h4>
              <p>Your Plex server is linked to your account. Access it at <a href="https://app.plex.tv" target="_blank" style="color:#e94560">app.plex.tv</a></p>
            </div>
            
            <p id="plexOfflineMsg" style="display: none; color: #f39c12; margin-top: 10px;">
              ‚ö†Ô∏è Plex is not running yet. Start the Docker stack first, or 
              <a href="https://app.plex.tv" target="_blank">manage Plex online</a>.
            </p>
          </div>
          
          <p style="margin-top: 20px; opacity:0.8; font-size:0.9rem;">
            Direct service links (local/LAN only):<br>
            <a href="http://localhost:32400/web" target="_blank" style="color:#e94560">Plex :32400</a> ¬∑ 
            <a href="http://localhost:8989" target="_blank" style="color:#e94560">Sonarr :8989</a> ¬∑ 
            <a href="http://localhost:7878" target="_blank" style="color:#e94560">Radarr :7878</a>
          </p>
        </div>
      </div>
    </div>
  </div>
  <script>
    let currentStep = 1; const totalSteps = 5;
    function updateProgress() {
      const p = document.getElementById('progress');
      p.innerHTML = Array.from({length: totalSteps}, (_, i) => `<div class="progress-dot ${i < currentStep ? 'active' : ''}"></div>`).join('');
      document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
      document.querySelector(`[data-step="${currentStep}"]`).classList.add('active');
    }
    function nextStep() { if (currentStep < totalSteps) { currentStep++; updateProgress(); } }
    function prevStep() { if (currentStep > 1) { currentStep--; updateProgress(); } }
    function collectConfig() {
      return {
        dataPath: document.getElementById('dataPath')?.value,
        appdataPath: document.getElementById('appdataPath')?.value,
        plexClaim: document.getElementById('plexClaim')?.value,
        puid: document.getElementById('puid')?.value,
        pgid: document.getElementById('pgid')?.value,
        tz: document.getElementById('tz')?.value,
        services: {
          plex: document.getElementById('svc-plex')?.checked,
          sonarr: document.getElementById('svc-sonarr')?.checked,
          radarr: document.getElementById('svc-radarr')?.checked
        }
      };
    }
    async function saveConfig() {
      try {
        await fetch('/api/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(collectConfig())
        });
        nextStep();
      } catch (e) { alert('Error saving config: ' + e.message); }
    }
    function setLaunchButtonsDisabled(disabled) {
      document.querySelectorAll('.btn-launch-plex').forEach((btn) => {
        btn.disabled = disabled;
      });
    }
    let plexUrl = null;
    async function checkPlexOnLoad() {
      const statusText = document.getElementById('plexStatusText');
      const claimSection = document.getElementById('claimSection');
      const claimStatus = document.getElementById('plexClaimStatus');
      const notClaimedBox = document.getElementById('plexNotClaimed');
      const offlineMsg = document.getElementById('plexOfflineMsg');

      try {
        const res = await fetch('/api/plex-status');
        const data = await res.json();

        if (data.online && data.claimed) {
          statusText.innerHTML = '‚úÖ Plex is online and claimed!';
          statusText.style.color = '#27ae60';
          setLaunchButtonsDisabled(false);
          plexUrl = data.url;
          if (claimSection) claimSection.style.display = 'none';
        } else if (data.online && !data.claimed) {
          statusText.innerHTML = '‚ö†Ô∏è Plex is online but NOT claimed';
          statusText.style.color = '#f39c12';
          setLaunchButtonsDisabled(true);
          if (claimSection) claimSection.style.display = 'block';
        } else {
          statusText.innerHTML = '‚ùå Plex is offline';
          statusText.style.color = '#e74c3c';
          setLaunchButtonsDisabled(true);
          if (claimSection) claimSection.style.display = 'none';
        }

        if (claimStatus) {
          claimStatus.innerHTML = data.online
          ? (data.claimed ? '<p>‚úÖ Plex is online and claimed.</p>' : '<p>‚ö†Ô∏è Plex is online but not claimed.</p>')
          : '<p>‚ùå Plex is offline.</p>';
        }
        if (offlineMsg) offlineMsg.style.display = data.online ? 'none' : 'block';
        if (notClaimedBox) notClaimedBox.style.display = (data.online && !data.claimed) ? 'block' : 'none';
        
        // Show claimed success box
        const claimedBox = document.getElementById('plexClaimed');
        if (claimedBox) claimedBox.style.display = (data.online && data.claimed) ? 'block' : 'none';

        return data;
      } catch (err) {
        statusText.innerHTML = '‚ùå Could not connect to Plex';
        statusText.style.color = '#e74c3c';
        setLaunchButtonsDisabled(true);
        if (claimStatus) {
          claimStatus.innerHTML = '<p>‚ùå Could not connect to Plex.</p>';
        }
        if (offlineMsg) offlineMsg.style.display = 'block';
        if (notClaimedBox) notClaimedBox.style.display = 'none';
        return null;
      }
    }
    function recheckPlex() {
        document.getElementById('plexStatusText').innerHTML = 'üîç Checking...';
        checkPlexOnLoad();
    }
    async function launchPlex(event) {
        const btn = event?.target || document.querySelector('[id="launchPlexBtn"]');
        const originalText = btn ? btn.textContent : '';
        if (btn) {
          btn.disabled = true;
          btn.textContent = 'üîç Checking...';
        }

        try {
            const res = await fetch('/api/plex-status');
            const data = await res.json();
            
            if (!data.online) {
                alert('‚ö†Ô∏è Plex is not running.\n\nStart your Docker stack or check Azure Container Apps.\n\nYou can also visit https://app.plex.tv to manage your servers.');
                if (btn) {
                  btn.disabled = false;
                  btn.textContent = originalText;
                }
                return;
            }

            if (data.online && !data.claimed) {
                const proceed = confirm(
                    '‚ö†Ô∏è Plex server is online but NOT CLAIMED!\n\n' +
                    'You must claim it with your Plex account before use.\n\n' +
                    '1. Go to https://www.plex.tv/claim/\n' +
                    '2. Copy the claim token (expires in 4 min)\n' +
                    '3. Redeploy with PLEX_CLAIM env var\n\n' +
                    'Open Plex anyway to attempt manual claim?'
                );
                if (!proceed) {
                  if (btn) {
                    btn.disabled = false;
                    btn.textContent = originalText;
                  }
                    return;
                }
            }

            // Open Plex
            const plexUrl = data.url || 'https://app.plex.tv';
            window.open(plexUrl, '_blank');
            
        } catch (err) {
            alert('‚ùå Error checking Plex: ' + err.message);
        }
        
        if (btn) {
          btn.disabled = false;
          btn.textContent = originalText;
        }
    }
      async function checkPlexStatus() {
        return checkPlexOnLoad();
      }
      async function updateClaimCode() {
        const code = (document.getElementById('claimCodeInput')?.value || document.getElementById('newClaimCode')?.value || '').trim();
        if (!code) {
          alert('Enter a Plex claim code first.');
          return;
        }

        const plexClaim = document.getElementById('plexClaim');
        if (plexClaim) plexClaim.value = code;

        const config = collectConfig();
        config.plexClaim = code;

        try {
          await fetch('/api/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(config)
          });
          alert('Saved claim code to config. Redeploy with PLEX_CLAIM to link Plex.');
        } catch (e) {
          alert('Failed to save claim code: ' + e.message);
        }
      }
    updateProgress();
    fetch('/api/status').then(r => r.json()).then(d => { if (!d.firstRun) currentStep = 5; updateProgress(); });
    checkPlexStatus();
  </script>
</body>
</html>