# Setup UI

The Setup UI is a lightweight onboarding wizard for the Eden Viewer media stack. It supports Synology DS923+ deployments and the optional Azure mirror stack, and is designed for LAN or VPN access.

- Local development (`npm start`) listens on HTTP port **8080** by default.
- The Docker image exposes HTTPS on port **3000** and generates a short-lived self-signed certificate at startup.

## Run locally with npm

```bash
cd setup-ui
npm install
npm start
```

The server binds to `http://localhost:8080`. If the port is in use, the app selects the next available port and prints the new URL in the startup banner.

Set `SETUP_UI_CERT_FILE` and `SETUP_UI_KEY_FILE` when you want to terminate TLS in-process. The server verifies that both files exist before enabling HTTPS.

## Run with Docker

```bash
# Build locally
docker build -t eden-setup-ui ./setup-ui

# Run with autogenerated self-signed cert
docker run --rm \
  -p 3000:3000 \
  -v "$(pwd)":/repo \
  -e SETUP_UI_REPO_ROOT=/repo \
  eden-setup-ui
```

The container entry point generates a short-lived self-signed certificate for `localhost`. Modern browsers warn because the certificate is not trusted.

## Bring Your Own Certificate (Recommended)

1. Place your certificate and key (PEM format) on the host. For Synology, store them under `/volume1/docker/appdata/setup-ui/certs` and back them up with the rest of your appdata.
2. Mount the directory into the container and point the app at the files:

```bash
docker run --rm \
  -p 3000:3000 \
  -v "$(pwd)":/repo \
  -e SETUP_UI_REPO_ROOT=/repo \
  -v /volume1/docker/appdata/setup-ui/certs:/certs:ro \
  -e SETUP_UI_CERT_FILE=/certs/fullchain.pem \
  -e SETUP_UI_KEY_FILE=/certs/privkey.pem \
  eden-setup-ui
```

- The entrypoint requires both `SETUP_UI_CERT_FILE` and `SETUP_UI_KEY_FILE`. If either file is missing, the container exits with an error.
- For Azure Container Apps, upload the PEM bundle and key as secrets, mount them into `/certs`, and set the same environment variables via `az containerapp secret set` + `--set-env-vars`.

## npm scripts

| Script | Description |
|--------|-------------|
| `npm start` | Runs the production server (`node server.js`). |
| `npm run dev` | Alias for `npm start`. Useful for local iterative development. |
| `npm run build` | Performs a syntax check on `server.js`. |
| `npm test` | Runs the test suite using Jest. |
| `npm run test:watch` | Runs tests in watch mode for development. |
| `npm run test:coverage` | Runs tests with coverage report. |
| `npm run test:integration` | Runs integration tests (starts server and verifies endpoints). |

## Testing

The Setup UI includes comprehensive test suites for both Node.js (server.js) and Python (app.py) implementations.

### Node.js Tests (Jest)

```bash
cd setup-ui

# Install dependencies
npm install

# Run all tests
npm test

# Run tests in watch mode (for development)
npm run test:watch

# Run tests with coverage report
npm run test:coverage
```

### Python Tests (pytest)

```bash
cd setup-ui

# Install dependencies
pip install -r requirements.txt -r requirements-dev.txt

# Run all tests
python -m pytest test_app.py -v

# Run with coverage
python -m pytest test_app.py --cov=app --cov-report=html
```

### Test Coverage

The test suites cover:

**Node.js (server.js):**
- API endpoints (`/api/health`, `/api/status`, `/api/config`)
- Configuration management (read/write)
- Utility functions (hostname sanitization, timeout handling)
- Rate limiting configuration

**Python (app.py):**
- Environment value sanitization and validation
- .env file parsing and generation
- Flask route handlers
- Security headers (CSP, X-Frame-Options, etc.)
- CSRF protection

### Integration Testing

An integration test script is available to verify the server starts correctly and responds to requests:

```bash
cd setup-ui
./integration-test.sh
```

This script:
- Starts the Setup UI server on a test port
- Verifies the server responds to health checks
- Tests the status endpoint
- Automatically cleans up after completion

### Continuous Integration

Tests run automatically on pull requests and pushes to main via GitHub Actions. See `.github/workflows/setup-ui-tests.yml` for the CI configuration.

## Certificate Renewal

- Automate renewals with Let's Encrypt (DNS-01 via Caddy, acme.sh, or Synology's built-in ACME client). After renewal, restart the container so Node reads the updated files.
- Schedule renewals during off-peak hours; certificate generation can briefly spike CPU usage on the DS923+ (Ryzen R1600).
- Always snapshot or back up `/volume1/docker/appdata/setup-ui/certs` before modifying certificates.

## Verification

```bash
# Confirm TLS handshake succeeds
curl -I https://nas.local:3000 --insecure

# With trusted certs, omit --insecure
curl -I https://setup.example.com:3000
```

When running in Azure, the `azure/smoke-test-azure.ps1` script verifies HTTPS reachability automatically. Combine that with `az containerapp revision list` logs to monitor for certificate load failures.

## Hardening Checklist

- Restrict access to VPN/Tailscale peers; avoid exposing port 3000 directly to the public internet.
- Use the same certificate authority (CA) as the rest of your stack to avoid browser trust prompts.
- Rotate certificates before expiry and remove unused secrets from Container Apps.
- Update `.env` entries (PUID/PGID/TZ) as needed when the setup UI writes files onto shared volumes.

## Features

- ðŸ§™ Multi-step configuration wizard
- Plex connectivity detection (domain â†’ LAN host â†’ localhost)
- TLS/HTTPS support through `SETUP_UI_CERT_FILE` / `SETUP_UI_KEY_FILE`
- Rate limiting (100 requests per 15 minutes per IP)
- Automatic port fallback if the default port is busy

## Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `SETUP_UI_PORT` | `8080` | Server port |
| `SETUP_UI_FIRST_RUN` | `false` | Force OOBE mode |
| `PLEX_DOMAIN` | - | Custom domain for Plex |
| `PLEX_LAN_HOST` | - | NAS IP for LAN checks |
| `SETUP_UI_CERT_FILE` | - | TLS certificate path |
| `SETUP_UI_KEY_FILE` | - | TLS private key path |

## API Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/health` | Health check |
| GET | `/api/status` | Configuration status |
| GET | `/api/config` | Current config |
| POST | `/api/config` | Save OOBE config |
| GET | `/api/plex-status` | Check Plex connectivity |

## Testing OOBE

```bash
# Reset first-run state
rm -f config/config.json
SETUP_UI_FIRST_RUN=true npm start
```
