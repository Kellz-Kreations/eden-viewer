# Setup UI

A lightweight onboarding helper that renders the Docker Compose configuration wizard for Synology DS923+ and the optional Azure mirror stack.

- Local dev (`npm start`) defaults to HTTP on port 3000.
- The Docker image defaults to HTTPS on port 3000 by generating a short-lived self-signed certificate at startup.

The UI is intended for LAN or VPN access only.

## Quick Start

```bash
# Build locally
docker build -t eden-setup-ui ./setup-ui

# Run with autogenerated self-signed cert
docker run --rm \
  -p 3000:3000 \
  -v "$(pwd)":/repo \
  -e SETUP_UI_REPO_ROOT=/repo \
  eden-setup-ui
```

By default the container entrypoint generates a short-lived self-signed certificate for `localhost`. Modern browsers will show a warning because the cert is not trusted.

## Bring Your Own Certificate (Recommended)

1. Place your certificate and key (PEM format) on the host. For Synology, store them under `/volume1/docker/appdata/setup-ui/certs` and back them up with the rest of your appdata.
2. Mount the directory into the container and point the app at the files:

```bash
docker run --rm \
  -p 3000:3000 \
  -v "$(pwd)":/repo \
  -e SETUP_UI_REPO_ROOT=/repo \
  -v /volume1/docker/appdata/setup-ui/certs:/certs:ro \
  -e SETUP_UI_CERT_FILE=/certs/fullchain.pem \
  -e SETUP_UI_KEY_FILE=/certs/privkey.pem \
  eden-setup-ui
```

- Both `SETUP_UI_CERT_FILE` and `SETUP_UI_KEY_FILE` must be set. The entrypoint validates the files exist and exits if they are missing.
- For Azure Container Apps, upload the PEM bundle and key as secrets, mount them into `/certs`, and set the same environment variables via `az containerapp secret set` + `--set-env-vars`.

## Certificate Renewal

- Automate renewals with Let‚Äôs Encrypt (DNS-01 via Caddy, acme.sh, or Synology‚Äôs built-in ACME client). After renewal, restart the container so Gunicorn reads the updated files.
- Schedule renewals during off-peak hours; certificate generation can briefly spike CPU usage on the DS923+ (Ryzen R1600).
- Always snapshot or back up `/volume1/docker/appdata/setup-ui/certs` before modifying certificates.

## Verification

```bash
# Confirm TLS handshake succeeds
curl -I https://nas.local:3000 --insecure

# With trusted certs, omit --insecure
curl -I https://setup.example.com:3000
```

When running in Azure, the `azure/smoke-test-azure.ps1` script verifies HTTPS reachability automatically. Combine that with `az containerapp revision list` logs to monitor for certificate load failures.

## Hardening Checklist

- Restrict access to VPN/Tailscale peers; avoid exposing port 3000 directly to the public internet.
- Use the same certificate authority (CA) as the rest of your stack to avoid browser trust prompts.
- Rotate certificates before expiry and remove unused secrets from Container Apps.
- Update `.env` entries (PUID/PGID/TZ) as needed when the setup UI writes files onto shared volumes.

# Eden Viewer Setup UI

Web-based OOBE wizard for configuring the Eden Viewer media stack.

## Quick Start

```bash
cd setup-ui
npm install
npm start
```

Access at **http://localhost:8080**

## Features

- üßô Multi-step configuration wizard
- üîç Plex connectivity detection (domain ‚Üí LAN ‚Üí localhost)
- üîê TLS/HTTPS support via `SETUP_UI_CERT_FILE` / `SETUP_UI_KEY_FILE`
- üö¶ Rate limiting (100 req/15 min per IP)
- üîÑ Auto port fallback if default port is busy

## Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `SETUP_UI_PORT` | `8080` | Server port |
| `SETUP_UI_FIRST_RUN` | `false` | Force OOBE mode |
| `PLEX_DOMAIN` | - | Custom domain for Plex |
| `PLEX_LAN_HOST` | - | NAS IP for LAN checks |
| `SETUP_UI_CERT_FILE` | - | TLS certificate path |
| `SETUP_UI_KEY_FILE` | - | TLS private key path |

## API Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/health` | Health check |
| GET | `/api/status` | Configuration status |
| GET | `/api/config` | Current config |
| POST | `/api/config` | Save OOBE config |
| GET | `/api/plex-status` | Check Plex connectivity |

## Testing OOBE

```bash
# Reset first-run state
rm -f config/config.json
SETUP_UI_FIRST_RUN=true npm start
```
