import os
import re
from typing import Any, Dict

from flask import Flask, jsonify, request

app = Flask(__name__)


def _extract_kv(query: str, key: str) -> str | None:
    # Matches KEY=/path, KEY=value, KEY = value (stops at whitespace or punctuation)
    pattern = rf"\b{re.escape(key)}\s*=\s*([^\s,;]+)"
    match = re.search(pattern, query)
    if not match:
        return None
    return match.group(1).strip().rstrip(".,;:)\"']")


def _env_response(query: str) -> str:
    defaults = {
        "APPDATA_ROOT": "/volume1/docker/appdata",
        "DATA_ROOT": "/volume1/data",
        "TRANSCODE_ROOT": "/volume1/docker/transcode",
        "PUID": "1026",
        "PGID": "100",
        "TZ": "America/Chicago",
    }

    values = dict(defaults)
    for key in list(values.keys()):
        extracted = _extract_kv(query, key)
        if extracted:
            values[key] = extracted

    lines = [
        "# Generated by local test agent (do not commit)",
        "",
        f"APPDATA_ROOT={values['APPDATA_ROOT']}",
        f"DATA_ROOT={values['DATA_ROOT']}",
        f"TRANSCODE_ROOT={values['TRANSCODE_ROOT']}",
        "",
        f"PUID={values['PUID']}",
        f"PGID={values['PGID']}",
        f"TZ={values['TZ']}",
    ]

    plex_claim = _extract_kv(query, "PLEX_CLAIM") or ""
    advertise_ip = _extract_kv(query, "ADVERTISE_IP") or ""
    lines += ["", f"PLEX_CLAIM={plex_claim}", f"ADVERTISE_IP={advertise_ip}"]

    lines.append("")
    return "\n".join(lines)


def _chatbot_response(_: str) -> str:
    # Keep aligned with repo instructions: Plex, Sonarr, Radarr only; LAN-first.
    return "\n".join(
        [
            "Use Plex, Sonarr, and Radarr only.",
            "Keep per-app configs under /volume1/docker/appdata/<app>.",
            "Prefer a single shared mount inside *arr containers at /data.",
            "Keep Sonarr/Radarr LAN-only; for remote access, prefer VPN.",
            "Note DS923+ has no Intel Quick Sync; plan around Direct Play.",
        ]
    )


def generate_response(query: str) -> str:
    q = (query or "").strip()
    lower = q.lower()

    # Simple heuristic: treat env requests as envgen.
    if ".env" in lower or "appdata_root" in lower or "puid" in lower or "pgid" in lower or "tz=" in lower:
        return _env_response(q)

    return _chatbot_response(q)


@app.get("/")
def root():
    return jsonify({"status": "ok", "endpoints": ["POST /chat"]})


@app.post("/chat")
def chat():
    payload: Dict[str, Any] = request.get_json(silent=True) or {}
    query = str(payload.get("query", ""))
    return jsonify({"response": generate_response(query)})


if __name__ == "__main__":
    port = int(os.environ.get("PORT", "8000"))
    app.run(host="127.0.0.1", port=port, debug=False)
